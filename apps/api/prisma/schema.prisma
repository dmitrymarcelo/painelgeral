generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum AssetType {
  CARRO
  CAMINHAO
  LANCHA
  MOTO
  MAQUINARIO
}

enum TriggerType {
  KM
  HORAS
  DATA
}

enum AssetStatus {
  DISPONIVEL
  EM_SERVICO
  EM_MANUTENCAO
  PARADO
}

enum WorkOrderStatus {
  ABERTA
  EM_ANDAMENTO
  AGUARDANDO
  CONCLUIDA
  CANCELADA
}

enum WorkOrderPriority {
  BAIXA
  NORMAL
  ALTA
  URGENTE
  CRITICA
}

enum ChecklistRunStatus {
  PENDENTE
  EM_CURSO
  CONCLUIDO
  BLOQUEADO
}

enum NotificationChannel {
  IN_APP
  PUSH
  EMAIL
}

enum UserRole {
  ADMIN
  GESTOR
  TECNICO
}

enum CalendarEventType {
  PREVENTIVA
  CORRETIVA
  VISTORIA
}

enum CalendarEventStatus {
  PROGRAMADA
  EM_EXECUCAO
  CONCLUIDA
  CANCELADA
}

enum ImportStatus {
  PENDENTE
  PROCESSANDO
  CONCLUIDO
  COM_ERROS
  FALHA
}

model Tenant {
  id          String   @id @default(cuid())
  slug        String   @unique
  name        String
  timezone    String   @default("America/Sao_Paulo")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  users       User[]
  roles       Role[]
  assets      Asset[]

  @@map("tenants")
}

model User {
  id               String          @id @default(cuid())
  tenantId         String
  email            String
  name             String
  passwordHash     String
  refreshTokenHash String?
  isActive         Boolean         @default(true)
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  tenant           Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  userRoles        UserRoleMap[]
  auditLogs        AuditLog[]
  notifications    Notification[]
  openedWorkOrders WorkOrder[]     @relation("work_order_opened_by")
  assignedRuns     ChecklistRun[]  @relation("checklist_run_assigned_to")
  assignments      WorkOrderAssignment[] @relation("work_order_assigned_to")

  @@unique([tenantId, email])
  @@index([tenantId, isActive])
  @@map("users")
}

model Role {
  id        String   @id @default(cuid())
  tenantId  String
  code      UserRole
  name      String
  createdAt DateTime @default(now())

  tenant    Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  userRoles UserRoleMap[]

  @@unique([tenantId, code])
  @@index([tenantId])
  @@map("roles")
}

model UserRoleMap {
  id         String   @id @default(cuid())
  tenantId   String
  userId     String
  roleId     String
  assignedAt DateTime @default(now())

  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  role       Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([tenantId, userId, roleId])
  @@index([tenantId, userId])
  @@map("user_roles")
}

model AuditLog {
  id          String   @id @default(cuid())
  tenantId    String
  userId      String?
  action      String
  resource    String
  resourceId  String?
  payload     Json?
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime @default(now())

  user        User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([tenantId, resource, createdAt])
  @@index([tenantId, userId])
  @@map("audit_logs")
}

model Notification {
  id          String   @id @default(cuid())
  tenantId    String
  userId      String
  title       String
  body        String
  isRead      Boolean  @default(false)
  readAt      DateTime?
  createdAt   DateTime @default(now())

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  deliveries  NotificationDelivery[]

  @@index([tenantId, userId, isRead])
  @@map("notifications")
}

model NotificationDelivery {
  id              String             @id @default(cuid())
  tenantId        String
  notificationId  String
  channel         NotificationChannel
  status          String
  providerId      String?
  sentAt          DateTime?
  createdAt       DateTime           @default(now())

  notification    Notification       @relation(fields: [notificationId], references: [id], onDelete: Cascade)

  @@index([tenantId, channel, status])
  @@map("notification_deliveries")
}

model Asset {
  id               String            @id @default(cuid())
  tenantId         String
  code             String
  plate            String?
  type             AssetType
  model            String
  manufacturer     String?
  status           AssetStatus       @default(DISPONIVEL)
  odometerKm       Float?
  engineHours      Float?
  locationName     String?
  qrCode           String?           @unique
  telemetryLastAt  DateTime?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt

  tenant           Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  statusHistory    AssetStatusHistory[]
  locations        AssetLocation[]
  telematicsDevices TelematicsDevice[]
  telematicsReadings TelematicsReading[]
  maintenancePlans MaintenancePlan[]
  maintenanceExecutions MaintenanceExecution[]
  calendarEvents   CalendarEvent[]
  workOrders       WorkOrder[]
  checklistRuns    ChecklistRun[]
  fuelEntries      FuelEntry[]

  @@unique([tenantId, code])
  @@index([tenantId, type, status])
  @@index([tenantId, plate])
  @@map("assets")
}

model AssetStatusHistory {
  id          String      @id @default(cuid())
  tenantId    String
  assetId     String
  status      AssetStatus
  reason      String?
  changedById String?
  createdAt   DateTime    @default(now())

  asset        Asset      @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@index([tenantId, assetId, createdAt])
  @@map("asset_status_history")
}

model AssetLocation {
  id         String   @id @default(cuid())
  tenantId   String
  assetId    String
  latitude   Float?
  longitude  Float?
  name       String?
  recordedAt DateTime @default(now())

  asset      Asset    @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@index([tenantId, assetId, recordedAt])
  @@map("asset_locations")
}

model TelematicsDevice {
  id            String   @id @default(cuid())
  tenantId      String
  assetId       String
  provider      String
  externalId    String
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())

  asset         Asset    @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@unique([tenantId, provider, externalId])
  @@index([tenantId, assetId])
  @@map("telematics_devices")
}

model TelematicsReading {
  id           String   @id @default(cuid())
  tenantId     String
  assetId      String
  provider     String
  externalEventId String?
  odometerKm   Float?
  engineHours  Float?
  recordedAt   DateTime
  rawPayload   Json?
  createdAt    DateTime @default(now())

  asset        Asset    @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@unique([tenantId, provider, externalEventId])
  @@index([tenantId, assetId, recordedAt])
  @@map("telematics_readings")
}

model MaintenancePlan {
  id            String              @id @default(cuid())
  tenantId      String
  assetId       String
  title         String
  description   String?
  isActive      Boolean             @default(true)
  nextDueAt     DateTime?
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt

  asset         Asset               @relation(fields: [assetId], references: [id], onDelete: Cascade)
  rules         MaintenanceRule[]
  executions    MaintenanceExecution[]

  @@index([tenantId, assetId, isActive])
  @@map("maintenance_plans")
}

model MaintenanceRule {
  id             String      @id @default(cuid())
  tenantId       String
  planId         String
  triggerType    TriggerType
  intervalValue  Float
  warningValue   Float?
  lastValue      Float?
  nextValue      Float?
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  plan           MaintenancePlan @relation(fields: [planId], references: [id], onDelete: Cascade)

  @@index([tenantId, planId])
  @@map("maintenance_rules")
}

model MaintenanceExecution {
  id               String           @id @default(cuid())
  tenantId         String
  planId           String
  assetId          String
  dueAt            DateTime?
  dueValue         Float?
  executedAt       DateTime?
  status           WorkOrderStatus  @default(ABERTA)
  workOrderId      String?
  createdAt        DateTime         @default(now())

  plan             MaintenancePlan  @relation(fields: [planId], references: [id], onDelete: Cascade)
  asset            Asset            @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@index([tenantId, planId, status])
  @@map("maintenance_executions")
}

model CalendarEvent {
  id            String              @id @default(cuid())
  tenantId      String
  title         String
  description   String?
  type          CalendarEventType
  status        CalendarEventStatus @default(PROGRAMADA)
  startAt       DateTime
  endAt         DateTime?
  assetId       String?
  workOrderId   String?
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt

  asset         Asset?              @relation(fields: [assetId], references: [id], onDelete: SetNull)

  @@index([tenantId, startAt, type])
  @@index([tenantId, status])
  @@map("calendar_events")
}

model WorkOrder {
  id            String            @id @default(cuid())
  tenantId      String
  code          String
  assetId       String
  service       String
  description   String?
  priority      WorkOrderPriority @default(NORMAL)
  status        WorkOrderStatus   @default(ABERTA)
  dueAt         DateTime?
  openedById    String
  startedAt     DateTime?
  completedAt   DateTime?
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  asset         Asset             @relation(fields: [assetId], references: [id], onDelete: Cascade)
  openedBy      User              @relation("work_order_opened_by", fields: [openedById], references: [id], onDelete: Restrict)
  tasks         WorkOrderTask[]
  assignments   WorkOrderAssignment[]
  history       WorkOrderHistory[]
  checklistRuns ChecklistRun[]

  @@unique([tenantId, code])
  @@index([tenantId, status, priority])
  @@index([tenantId, assetId])
  @@map("work_orders")
}

model WorkOrderTask {
  id            String   @id @default(cuid())
  tenantId      String
  workOrderId   String
  title         String
  isDone        Boolean  @default(false)
  sortOrder     Int      @default(0)
  createdAt     DateTime @default(now())

  workOrder     WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)

  @@index([tenantId, workOrderId])
  @@map("work_order_tasks")
}

model WorkOrderAssignment {
  id            String   @id @default(cuid())
  tenantId      String
  workOrderId   String
  userId        String
  assignedAt    DateTime @default(now())

  workOrder     WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)
  user          User      @relation("work_order_assigned_to", fields: [userId], references: [id], onDelete: Restrict)

  @@unique([tenantId, workOrderId, userId])
  @@index([tenantId, userId])
  @@map("work_order_assignments")
}

model WorkOrderHistory {
  id            String          @id @default(cuid())
  tenantId      String
  workOrderId   String
  fromStatus    WorkOrderStatus?
  toStatus      WorkOrderStatus
  note          String?
  createdById   String?
  createdAt     DateTime        @default(now())

  workOrder     WorkOrder       @relation(fields: [workOrderId], references: [id], onDelete: Cascade)

  @@index([tenantId, workOrderId, createdAt])
  @@map("work_order_history")
}

model ChecklistTemplate {
  id            String                 @id @default(cuid())
  tenantId      String
  name          String
  description   String?
  isActive      Boolean                @default(true)
  createdAt     DateTime               @default(now())
  updatedAt     DateTime               @updatedAt

  items         ChecklistTemplateItem[]
  runs          ChecklistRun[]

  @@index([tenantId, isActive])
  @@map("checklist_templates")
}

model ChecklistTemplateItem {
  id            String             @id @default(cuid())
  tenantId      String
  templateId    String
  label         String
  itemType      String
  required      Boolean            @default(true)
  sortOrder     Int                @default(0)

  template      ChecklistTemplate  @relation(fields: [templateId], references: [id], onDelete: Cascade)
  answers       ChecklistAnswer[]

  @@index([tenantId, templateId, sortOrder])
  @@map("checklist_template_items")
}

model ChecklistRun {
  id             String             @id @default(cuid())
  tenantId       String
  templateId     String
  assetId        String?
  workOrderId    String?
  assignedToId   String?
  status         ChecklistRunStatus @default(PENDENTE)
  idempotencyKey String?
  startedAt      DateTime?
  completedAt    DateTime?
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt

  template       ChecklistTemplate  @relation(fields: [templateId], references: [id], onDelete: Restrict)
  asset          Asset?             @relation(fields: [assetId], references: [id], onDelete: SetNull)
  workOrder      WorkOrder?         @relation(fields: [workOrderId], references: [id], onDelete: SetNull)
  assignedTo     User?              @relation("checklist_run_assigned_to", fields: [assignedToId], references: [id], onDelete: SetNull)
  answers        ChecklistAnswer[]
  attachments    ChecklistAttachment[]
  signatures     ChecklistSignature[]

  @@unique([tenantId, idempotencyKey])
  @@index([tenantId, status, assignedToId])
  @@map("checklist_runs")
}

model ChecklistAnswer {
  id             String               @id @default(cuid())
  tenantId       String
  runId          String
  templateItemId String
  value          String?
  note           String?
  createdAt      DateTime             @default(now())

  run            ChecklistRun         @relation(fields: [runId], references: [id], onDelete: Cascade)
  templateItem   ChecklistTemplateItem @relation(fields: [templateItemId], references: [id], onDelete: Restrict)

  @@unique([tenantId, runId, templateItemId])
  @@index([tenantId, runId])
  @@map("checklist_answers")
}

model ChecklistAttachment {
  id             String       @id @default(cuid())
  tenantId       String
  runId          String
  url            String
  mimeType       String
  size           Int
  note           String?
  createdAt      DateTime     @default(now())

  run            ChecklistRun @relation(fields: [runId], references: [id], onDelete: Cascade)

  @@index([tenantId, runId])
  @@map("checklist_attachments")
}

model ChecklistSignature {
  id             String       @id @default(cuid())
  tenantId       String
  runId          String
  signedById     String?
  signerName     String
  dataUrl        String
  signedAt       DateTime     @default(now())

  run            ChecklistRun @relation(fields: [runId], references: [id], onDelete: Cascade)

  @@index([tenantId, runId])
  @@map("checklist_signatures")
}

model FuelEntry {
  id             String    @id @default(cuid())
  tenantId       String
  assetId        String
  liters         Float
  unitPrice      Float
  totalPrice     Float
  odometerKm     Float?
  fueledAt       DateTime
  stationName    String?
  note           String?
  createdAt      DateTime  @default(now())

  asset          Asset     @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@index([tenantId, fueledAt])
  @@index([tenantId, assetId])
  @@map("fuel_entries")
}

model ImportJob {
  id             String      @id @default(cuid())
  tenantId       String
  resource       String
  status         ImportStatus @default(PENDENTE)
  totalRows      Int          @default(0)
  successRows    Int          @default(0)
  errorRows      Int          @default(0)
  createdById    String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  rows           ImportRow[]
  errors         ImportError[]

  @@index([tenantId, resource, status])
  @@map("import_jobs")
}

model ImportRow {
  id             String    @id @default(cuid())
  tenantId       String
  importJobId    String
  rowNumber      Int
  payload        Json
  status         ImportStatus @default(PENDENTE)
  createdAt      DateTime  @default(now())

  importJob      ImportJob @relation(fields: [importJobId], references: [id], onDelete: Cascade)
  errors         ImportError[]

  @@index([tenantId, importJobId, rowNumber])
  @@map("import_rows")
}

model ImportError {
  id             String    @id @default(cuid())
  tenantId       String
  importJobId    String
  importRowId    String?
  code           String
  message        String
  createdAt      DateTime  @default(now())

  importJob      ImportJob @relation(fields: [importJobId], references: [id], onDelete: Cascade)
  importRow      ImportRow? @relation(fields: [importRowId], references: [id], onDelete: SetNull)

  @@index([tenantId, importJobId])
  @@map("import_errors")
}

model TelemetrySync {
  id              String   @id @default(cuid())
  tenantId        String
  provider        String
  lastWebhookAt   DateTime?
  lastBackfillAt  DateTime?
  totalEvents     Int      @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([tenantId, provider])
  @@map("telemetry_sync")
}
